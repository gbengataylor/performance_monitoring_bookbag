:guid: %guid%
:user: %user%

:openshift_user_password: %password%
:openshift_console_url: %openshift_console_url%
:user_devworkspace_url: https://devspaces.%openshift_cluster_ingress_domain%
:hyperfoil_web_cli_url: https://%user%-hyperfoil.%openshift_cluster_ingress_domain%
:hyperfoil_benchmark_definition_url: 'https://raw.githubusercontent.com/redhat-na-ssa/workshop_performance-monitoring-apps-template/main/scripts/hyperfoil/summit-load-apps.hf.yaml'
:grafana_url: https://grafana-route-grafana.%openshift_cluster_ingress_domain%

:markup-in-source: verbatim,attributes,quotes
:source-highlighter: highlight.js

= Load Testing, Scaling and Monitoring the Applications

== Logs

The http://portal.azure.com[Azure Portal] also provides a nice interface to view the logs of your application.
This is crucial to troubleshoot issues when something goes wrong.

You have multiple options to view the different logs of your application:

- You can connect to a given container apps instance and gets the stream of console logs.
This is useful to troubleshoot issues with a specific instance of your application in real time.

- You can also access the console logs in http://portal.azure.com[Azure Portal].
You get access to all logs from the https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview[Log Analytics] workspace we created earlier.
Using SQL-like queries (called https://learn.microsoft.com/azure/data-explorer/kusto/query[Kusto Query Language], or KQL), you can filter the logs and get the information you need across all your applications, revisions, and instances.

- Finally, you also have access to the _system logs_, which are the logs of the container host.
It's very useful to troubleshoot issues with the container host itself and find out why your container is not running.

=== Streaming logs of a container instance

The most straightforward way to access the logs of your application is to connect to a given container instance and get the stream of console logs.
You can directly access the stream of logs from the latest revision of a running instance of your application with this command:

[source,shell]
----
 az containerapp logs show \
  --name "$QUARKUS_APP" \
  --resource-group "$RESOURCE_GROUP" \
  --format text \
  --follow
----

[TIP]
====
Don't forget that by default, containers apps scale out to 0 instances when they are not used.
You can use the command `curl https://${QUARKUS_HOST}/quarkus` to wake up the container app first if the connections fails.
====

Once you're connected, you can see the logs of your application in real time.
The `--follow` option keeps the connection open to see the new logs in real time.

In a different terminal, you can use the `curl` command to generate some load on the application.
You should see the logs of the application being updated in real time.

[source,shell]
----
curl https://${QUARKUS_HOST}/quarkus/cpu?iterations=10
----

=== Viewing the console logs in Azure portal

You can also access the console logs in the http://portal.azure.com[Azure Portal] or via CLI.
Using https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview[Log Analytics], you get access to all logs from all your applications, revisions, and instances.
This means you can troubleshoot issues across all your applications, tracing requests as needed, which is crucial if your application use a microservices architecture.

Open the http://portal.azure.com[Azure Portal] and navigate to the resource group `rg-java-runtimes` you created for your application.
Select the `logs-java-runtimes` container app, then select *Logs* from the left menu, under the *General* group.

By default, you are presented a list of pre-defined queries.
Close this panel by clicking on the *X* button on the top right corner, as we'll create our own query.

image::../assets/log-analytics.png[Screenshot of the Azure portal showing the logs analytics panel]

Log analytics queries use the https://docs.microsoft.com/en-us/azure/azure-monitor/log-query/query-language[Kusto query language], which is a SQL-like language.
You can use the query language to filter the logs and get the information you need.

Let's start by creating a query to get the logs of the `quarkus-app` container app.
Enter this query in the editor:

[source,sql]
----
ContainerAppConsoleLogs_CL
| where RevisionName_s == "quarkus-app--<REVISION_ID>"
----

You can get the app revision name by running the following command:

[source,shell]
----
az containerapp revision list \
  --name "$QUARKUS_APP" \
  --resource-group "$RESOURCE_GROUP" \
  --query "[0].name" --output tsv
----

Select *Run* to execute the query.
You should see the logs of the `quarkus-app` container app.

image::../assets/log-analytics-query.png[Screenshot of the logs results in Azure portal]

For now, it's not very useful as it's the same logs we saw in the previous section.
Let's add some filters to the query to search for error messages from the logs:

[source,sql]
----
ContainerAppConsoleLogs_CL
| where RevisionName_s == "quarkus-app--<REVISION_ID>"
| where Log_s !has "INFO"
| where Log_s contains "error"
----

Select *Run* to execute the query.
If your application is working fine, you should not see any results.
Let's generate some errors by crashing the application with the following command:

[source,shell]
----
curl https://${QUARKUS_HOST}/quarkus/memory?bites=1000
----

Oops! We're trying to allocate more memory than the container has available, resulting in a crash because of our (crude) memory allocation algorithm.

If you run the query again, you should see the error message in the logs:

image::../assets/log-analytics-error.png[Screenshot of the logs results in Azure portal]

[TIP]
====
Of course, you can go much further with the query language.
You can have a look at the https://learn.microsoft.com/en-us/azure/data-explorer/kql-quick-reference[quick reference] to play a bit with the queries.
====

We can make it easier to read by making the latest logs appear at the top of the results, and only show the time and message of the last 10 logs:

[source,sql]
----
ContainerAppConsoleLogs_CL
| where RevisionName_s == "quarkus-app--<REVISION_ID>"
| where Log_s !has "INFO"
| where Log_s contains "error"
| project TimeGenerated, Log_s
| sort by TimeGenerated desc
| take 10
----

And here we can quickly see our `OutOfMemoryError` error message.

image::../assets/log-analytics-error-2.png[Screenshot of the logs results in Azure portal]

We can save the query for later use by clicking on the *Save* button.
You can then give it a name and a description, and a category to quickly find it later.

=== Viewing the console logs with the CLI

You can also view the logs via a CLI command instead of using the portal.
It's just a matter of writing any KQL query in the `analytics-query` parameter as follow:

[source,shell]
----
az monitor log-analytics query \
--workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
--analytics-query "ContainerAppConsoleLogs_CL | where RevisionName_s == 'quarkus-app--<REVISION_ID>'" \
--output table
----

=== Viewing the system logs

While console logs are very useful to troubleshoot issues with your application, it won't be much help if your container is not running.
In this case, you need to troubleshoot the container host itself.
This is where the _system logs_ come in handy.

The system logs are the logs of the container host.
They are very useful to troubleshoot issues with the container host itself and monitor its activity during provisioning operations.

System logs can be accessed the same way as console logs.
Change the previous query in the editor to get the system logs:

[source,sql]
----
ContainerAppSystemLogs_CL
| where RevisionName_s == "quarkus-app--<REVISION_ID>"
| project TimeGenerated, Reason_s, Log_s
| sort by TimeGenerated desc
----

You should see the system logs of the `quarkus-app` container app, covering the whole lifecycle of the container.

image::../assets/log-analytics-system.png[Screenshot of the logs results in Azure portal]

Using the CLI you can execute:

[source,shell]
----
az monitor log-analytics query \
--workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
--analytics-query "ContainerAppSystemLogs_CL | where RevisionName_s == 'quarkus-app--<REVISION_ID>' | project TimeGenerated, Reason_s, Log_s | sort by TimeGenerated desc" \
--output table
----
